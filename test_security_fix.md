# 安全漏洞修复测试指南

## 修复内容

已修复房间密码验证绕过漏洞。现在有密码保护的聊天室需要通过密码验证才能访问。

## 修复原理

### 后端修改 (backend/main.py)

1. **添加房间访问令牌系统**
   - 引入 `room_access_tokens` 字典存储有效的房间访问令牌
   - 用户通过密码验证后，生成唯一的访问令牌

2. **创建房间时生成令牌** (main.py:72-83)
   - 创建房间时自动生成访问令牌
   - 返回令牌给创建者

3. **加入房间时生成令牌** (main.py:86-100)
   - 验证密码成功后生成访问令牌
   - 返回令牌给加入者

4. **获取消息时验证令牌** (main.py:102-115)
   - 检查房间是否有密码保护
   - 如果有密码，验证请求头中的 `X-Room-Access-Token`
   - 无效令牌返回 403 错误

5. **WebSocket 连接时验证令牌** (main.py:261-273)
   - 检查房间是否有密码保护
   - 如果有密码，验证查询参数中的 `room_access_token`
   - 无效令牌关闭连接

### 前端修改

1. **Home.vue - 保存令牌**
   - 创建房间后保存令牌到 sessionStorage (Home.vue:49-52)
   - 加入房间后保存令牌到 sessionStorage (Home.vue:82-85)

2. **Chat.vue - 使用令牌**
   - 加载历史消息时在请求头中发送令牌 (Chat.vue:46-50, 52)
   - 连接 WebSocket 时在 URL 参数中发送令牌 (Chat.vue:72, 78-86)
   - 处理 403 错误和 WebSocket 关闭事件 (Chat.vue:59-61, 120-125)

## 测试步骤

### 测试 1: 验证无密码房间仍可正常访问

1. 启动后端和前端服务
2. 创建一个无密码的房间
3. 直接访问房间 URL（如 http://localhost:5173/chat/abc123）
4. **预期结果**: 可以正常访问和发送消息

### 测试 2: 验证有密码房间需要验证

1. 创建一个有密码的房间（例如密码为 "test123"）
2. 记录房间 ID（例如 "327087d3"）
3. 在另一个浏览器或隐身窗口中直接访问房间 URL
   - 例如: http://localhost:5173/chat/327087d3?name=测试房间
4. **预期结果**:
   - 无法加载历史消息
   - WebSocket 连接被拒绝
   - 显示"无权访问此房间，请先验证密码"提示
   - 自动跳转回首页

### 测试 3: 验证正确密码可以访问

1. 在首页点击有密码的房间
2. 输入正确的密码
3. **预期结果**:
   - 成功进入聊天室
   - 可以查看历史消息
   - 可以发送消息

### 测试 4: 验证错误密码被拒绝

1. 在首页点击有密码的房间
2. 输入错误的密码
3. **预期结果**: 显示"密码错误或房间不存在"提示

### 测试 5: 验证令牌持久性

1. 通过正确密码进入有密码的房间
2. 刷新页面
3. **预期结果**:
   - 仍然可以访问房间（因为令牌保存在 sessionStorage）
   - 可以查看历史消息和发送消息

### 测试 6: 验证令牌隔离

1. 在浏览器 A 中通过密码进入房间
2. 在浏览器 B 中尝试直接访问相同的房间 URL
3. **预期结果**:
   - 浏览器 B 无法访问（令牌存储在 sessionStorage，不会跨浏览器）
   - 显示访问被拒绝的提示

## 安全性说明

1. **令牌存储**: 使用 sessionStorage 而非 localStorage，关闭标签页后令牌自动清除
2. **令牌生成**: 使用 `secrets.token_urlsafe(32)` 生成加密安全的随机令牌
3. **验证点**: 在所有关键访问点（消息获取、WebSocket 连接）都进行验证
4. **无密码房间**: 无密码房间不受影响，保持原有的开放访问方式

## 注意事项

1. 当前实现使用内存存储令牌，服务器重启后令牌会丢失
2. 建议在生产环境中使用 Redis 等持久化存储
3. 可以考虑添加令牌过期时间以提高安全性
4. 可以考虑限制每个房间的令牌数量以防止滥用
